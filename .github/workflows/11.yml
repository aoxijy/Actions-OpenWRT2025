name: åˆ é™¤åŒ…å«å…³é”®å­—çš„ Releases å’Œ Tags

on:
  workflow_dispatch:
    inputs:
      firmware_message:
        description: 'åŒ¹é…å…³é”®å­—ï¼ˆç”¨äºåŒ¹é… tagã€åç§°æˆ–æè¿°ï¼‰'
        required: true
        default: 'Lede_Cudy_18.04'

jobs:
  clean_releases:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½® FIRMWARE_MESSAGE ç¯å¢ƒå˜é‡
        run: echo "FIRMWARE_MESSAGE=${{ github.event.inputs.firmware_message }}" >> $GITHUB_ENV

      - name: åˆ é™¤åŒ¹é…å…³é”®å­—çš„ Releases å’Œ Tags
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: |
          echo "åŒ¹é…å…³é”®å­—: $FIRMWARE_MESSAGE"

          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          # è®¾ç½® Git è¿œç¨‹åœ°å€ä¸ºå¸¦ Token çš„å½¢å¼ï¼Œé¿å… 403
          git remote set-url origin https://${GITHUB_TOKEN}@github.com/${{ github.repository }}

          releases=$(gh api repos/${{ github.repository }}/releases --paginate)

          echo "$releases" | jq -c '.[]' | while read -r release; do
            tag=$(echo "$release" | jq -r '.tag_name')
            name=$(echo "$release" | jq -r '.name')
            body=$(echo "$release" | jq -r '.body')

            echo "æ£€æŸ¥ tag: $tag"
            echo "       name: $name"
            echo "       body: ${body:0:40}..."

            if [[ "$tag" == *"$FIRMWARE_MESSAGE"* || "$name" == *"$FIRMWARE_MESSAGE"* || "$body" == *"$FIRMWARE_MESSAGE"* ]]; then
              echo "ğŸ—‘ï¸ åˆ é™¤ Release å’Œ Tag: $tag"
              gh release delete "$tag" --yes
              git push origin ":refs/tags/$tag"
            fi
          done
